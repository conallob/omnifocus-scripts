name: Release and Update Homebrew Formula

on:
  push:
    tags:
      # More specific pattern to enforce semantic versioning
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'  # Allow pre-release tags like v1.0.0-beta.1

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.HOMEBREW_TAP_TOKEN }}" ]; then
            echo "‚ùå Error: HOMEBREW_TAP_TOKEN secret is not set"
            echo "Please configure the secret in repository settings:"
            echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi
          echo "‚úÖ Required secrets are configured"

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "üì¶ Creating release for version: $VERSION"

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## üéâ OmniFocus Scripts ${{ steps.get_version.outputs.tag }}

          ### üì• Installation

          **Via Homebrew (Recommended):**
          ```bash
          brew tap conallob/tap
          brew install omnifocus-scripts
          ```

          **Manual Installation:**
          ```bash
          # Download and extract
          curl -L https://github.com/${{ github.repository }}/archive/${{ steps.get_version.outputs.tag }}.tar.gz | tar xz
          cd omnifocus-scripts-${{ steps.get_version.outputs.version }}

          # Copy to desired location
          sudo mkdir -p /opt/homebrew/share/omnifocus-scripts
          sudo cp -r * /opt/homebrew/share/omnifocus-scripts/
          ```

          ### üì¶ What's Included

          - **Slack Integration**: Import starred Slack messages into OmniFocus
          - **Reschedule Overdue**: Automatically reschedule overdue tasks

          ### üìñ Documentation

          See the [README](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.tag }}/README.md) for detailed usage instructions.

          ### üìù Changelog

          <!-- Auto-generated changelog will appear below -->
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for GitHub to generate release tarball
        run: |
          echo "‚è≥ Waiting for GitHub to generate release archive..."
          sleep 10

      - name: Calculate SHA256 for Homebrew
        id: calculate_sha
        run: |
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/${{ steps.get_version.outputs.tag }}.tar.gz"
          echo "üì• Downloading release tarball with retry logic..."

          # Retry logic with exponential backoff
          MAX_ATTEMPTS=5
          ATTEMPT=1
          DELAY=2

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            if curl -fsSL "$TARBALL_URL" -o release.tar.gz; then
              # Verify the download succeeded and file is not empty
              if [ -s release.tar.gz ]; then
                echo "‚úÖ Download successful"
                break
              else
                echo "‚ö†Ô∏è  Downloaded file is empty"
                rm -f release.tar.gz
              fi
            else
              echo "‚ö†Ô∏è  Download failed"
            fi

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "‚ùå Failed to download tarball after $MAX_ATTEMPTS attempts"
              exit 1
            fi

            echo "Waiting ${DELAY}s before retry..."
            sleep $DELAY
            DELAY=$((DELAY * 2))
            ATTEMPT=$((ATTEMPT + 1))
          done

          # Calculate SHA256
          SHA256=$(shasum -a 256 release.tar.gz | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "üîê Calculated SHA256: $SHA256"

      - name: Update Homebrew Formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Use a temporary directory for the tap clone
          TEMP_DIR=$(mktemp -d)
          trap "rm -rf $TEMP_DIR" EXIT

          cd "$TEMP_DIR"

          # Clone using gh CLI for secure authentication
          echo "üì• Cloning homebrew-tap repository..."
          gh repo clone conallob/homebrew-tap
          cd homebrew-tap

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create Formula directory if it doesn't exist
          mkdir -p Formula

          # Generate formula from template
          echo "üìù Generating Homebrew formula..."
          sed -e "s|__VERSION__|${{ steps.get_version.outputs.version }}|g" \
              -e "s|__TAG__|${{ steps.get_version.outputs.tag }}|g" \
              -e "s|__SHA256__|${{ steps.calculate_sha.outputs.sha256 }}|g" \
              "$GITHUB_WORKSPACE/.github/homebrew-formula-template.rb" \
              > Formula/omnifocus-scripts.rb

          # Verify the formula was generated correctly
          if ! grep -q "${{ steps.get_version.outputs.version }}" Formula/omnifocus-scripts.rb; then
            echo "‚ùå Formula generation failed - version not found"
            exit 1
          fi

          # Check if there are actual changes
          if git diff --quiet Formula/omnifocus-scripts.rb 2>/dev/null; then
            echo "‚ÑπÔ∏è  No changes to formula (version might already exist)"
          else
            # Commit and push the formula
            git add Formula/omnifocus-scripts.rb
            git commit -m "omnifocus-scripts: update to ${{ steps.get_version.outputs.version }}"

            echo "üì§ Pushing formula update..."
            gh repo set-default conallob/homebrew-tap
            git push origin main

            echo "‚úÖ Formula updated successfully"
          fi

      - name: Verify Formula Installation
        run: |
          echo "‚úÖ Release ${{ steps.get_version.outputs.tag }} created successfully"
          echo "‚úÖ Homebrew formula updated"
          echo ""
          echo "Users can now install with:"
          echo "  brew tap conallob/tap"
          echo "  brew install omnifocus-scripts"
          echo ""
          echo "Or upgrade existing installations:"
          echo "  brew upgrade omnifocus-scripts"

  # Separate job to test the formula
  test-formula:
    needs: release
    runs-on: macos-latest
    steps:
      - name: Set up Homebrew
        run: |
          brew update
          brew tap conallob/tap

      - name: Wait for tap to update
        run: |
          echo "‚è≥ Waiting for tap to sync..."
          sleep 30

      - name: Audit formula
        run: |
          echo "üîç Running brew audit..."
          brew audit --strict conallob/tap/omnifocus-scripts || true

      - name: Test installation
        run: |
          echo "üß™ Testing formula installation..."
          brew install omnifocus-scripts
          brew test omnifocus-scripts

          # Verify installation location
          INSTALL_PATH=$(brew --prefix)/share/omnifocus-scripts
          if [ -d "$INSTALL_PATH" ]; then
            echo "‚úÖ Scripts installed to: $INSTALL_PATH"
            ls -la "$INSTALL_PATH"
          else
            echo "‚ùå Installation path not found: $INSTALL_PATH"
            exit 1
          fi

      - name: Test uninstallation
        run: |
          echo "üßπ Testing uninstallation..."
          brew uninstall omnifocus-scripts
          echo "‚úÖ Uninstallation successful"
