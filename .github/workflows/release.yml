name: Release and Update Homebrew Formula

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## OmniFocus Scripts ${{ steps.get_version.outputs.tag }}

          ### Installation

          **Via Homebrew:**
          ```bash
          brew tap conallob/tap
          brew install omnifocus-scripts
          ```

          **Manual Installation:**
          ```bash
          # Download and extract
          curl -L https://github.com/${{ github.repository }}/archive/${{ steps.get_version.outputs.tag }}.tar.gz | tar xz

          # Copy to desired location
          sudo mkdir -p /opt/homebrew/share/omnifocus-scripts
          sudo cp -r omnifocus-scripts-${{ steps.get_version.outputs.version }}/* /opt/homebrew/share/omnifocus-scripts/
          ```

          ### What's Included

          - **Slack Integration**: Import starred Slack messages into OmniFocus
          - **Reschedule Overdue**: Automatically reschedule overdue tasks

          See the [README](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.tag }}/README.md) for detailed usage instructions.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate SHA256 for Homebrew
        id: calculate_sha
        run: |
          # Download the tarball that GitHub created
          curl -sL https://github.com/${{ github.repository }}/archive/${{ steps.get_version.outputs.tag }}.tar.gz -o release.tar.gz

          # Calculate SHA256
          SHA256=$(shasum -a 256 release.tar.gz | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Calculated SHA256: $SHA256"

      - name: Update Homebrew Formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Clone the homebrew-tap repository
          git clone https://conallob:${HOMEBREW_TAP_TOKEN}@github.com/conallob/homebrew-tap.git
          cd homebrew-tap

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create Formula directory if it doesn't exist
          mkdir -p Formula

          # Create or update the formula
          cat > Formula/omnifocus-scripts.rb << 'EOF'
          class OmnifocusScripts < Formula
            desc "Automation scripts for OmniFocus task management"
            homepage "https://github.com/conallob/omnifocus-scripts"
            url "https://github.com/conallob/omnifocus-scripts/archive/${{ steps.get_version.outputs.tag }}.tar.gz"
            sha256 "${{ steps.calculate_sha.outputs.sha256 }}"
            version "${{ steps.get_version.outputs.version }}"
            license "MIT"

            depends_on :macos

            def install
              # Install all scripts to share directory
              share.install Dir["*"]

              # Create symlink for easy access
              (prefix/"omnifocus-scripts").install_symlink share
            end

            def caveats
              <<~EOS
                OmniFocus scripts have been installed to:
                  #{opt_share}

                Available scripts:
                  • Slack Integration: #{opt_share}/slack-integration/
                  • Reschedule Overdue: #{opt_share}/reschedule-overdue/

                For detailed usage instructions, see:
                  #{opt_share}/README.md
              EOS
            end

            test do
              assert_predicate share/"README.md", :exist?
              assert_predicate share/"slack-integration", :exist?
              assert_predicate share/"reschedule-overdue", :exist?
            end
          end
          EOF

          # Commit and push the formula
          git add Formula/omnifocus-scripts.rb
          git commit -m "omnifocus-scripts: update to ${{ steps.get_version.outputs.version }}"
          git push origin main

      - name: Verify Formula Installation
        run: |
          echo "✅ Release ${{ steps.get_version.outputs.tag }} created successfully"
          echo "✅ Homebrew formula updated"
          echo ""
          echo "Users can now install with:"
          echo "  brew tap conallob/tap"
          echo "  brew install omnifocus-scripts"
